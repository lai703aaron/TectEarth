<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoDrift: 3D Earth Evolution Simulator</title>
  
  <!-- Upgraded CDNs with fallback -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js" onerror="loadFallbackThree()"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/OrbitControls.js" onerror="console.warn('Controls fallback active')"></script>

  <style>
    /* Updated Style: Glows, gradients, mobile-first */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; background: radial-gradient(circle at center, #000011 0%, #000000 100%); font-family: system-ui, sans-serif; color: white; }
    #container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    .ui {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.85); padding: 25px 40px; border-radius: 25px;
      text-align: center; backdrop-filter: blur(20px); box-shadow: 0 15px 50px rgba(0,0,0,0.8), 0 0 30px rgba(255,107,0,0.2); /* New glow shadow */
      z-index: 100; max-width: 85%; border: 1px solid rgba(255,107,0,0.5); transition: all 0.3s ease;
    }
    .ui:hover { box-shadow: 0 20px 60px rgba(0,0,0,0.9), 0 0 40px rgba(255,107,0,0.3); } /* Hover glow */
    h1 {
      font-size: 2.4em; background: linear-gradient(90deg, #ff8a00, #da1b60, #00ffcc); /* Updated multi-gradient */
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(255,107,0,0.5));
    }
    #timeLabel { 
      font-size: 1.6em; font-weight: bold; color: #00ffcc; margin: 15px 0; 
      text-shadow: 0 0 10px #00ffcc; /* New glow text */
    }
    #timeSlider {
      width: 100%; height: 14px; border-radius: 7px; background: linear-gradient(to right, #ff6b00, #00ffcc);
      outline: none; margin: 20px 0; -webkit-appearance: none; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }
    #timeSlider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(#fff, #ff6b00);
      cursor: pointer; box-shadow: 0 0 20px #ff6b00; border: 2px solid #fff; /* Updated thumb glow */
    }
    .buttons button {
      margin: 8px; padding: 12px 25px; background: linear-gradient(#ff6b00, #ff8a00); /* Gradient buttons */
      border: none; border-radius: 30px; color: white; font-size: 1em; cursor: pointer; 
      transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 15px rgba(255,107,0,0.4);
    }
    .buttons button:hover { 
      background: linear-gradient(#ff8a00, #ff6b00); transform: scale(1.05); box-shadow: 0 6px 20px rgba(255,107,0,0.6); /* Enhanced hover */
    }
    .info { margin-top: 10px; font-size: 0.9em; opacity: 0.85; line-height: 1.4; }
    #debug {
      position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 8px;
      color: lime; font-size: 0.9em; z-index: 101; font-family: monospace; border: 1px solid lime;
      transition: opacity 0.5s; /* Fade out on success */
    }
    #debug.success { opacity: 0.3; }
    @media (max-width: 768px) { /* Mobile updates */
      .ui { padding: 20px 30px; bottom: 10px; max-width: 95%; }
      h1 { font-size: 2em; }
      #timeSlider { height: 12px; }
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="debug">Initializing 3D Earth... (Drag to rotate once loaded)</div>

  <div class="ui">
    <h1>GeoDrift</h1>
    <p id="timeLabel">ÁèæÂú® (0 Ma)</p>
    <input type="range" id="timeSlider" min="-600" max="250" value="0" step="10">
    <div class="buttons">
      <button id="playBtn">Êí≠ÊîæÂãïÁï´</button>
      <button id="resetBtn">ÂõûÂà∞ÁèæÂú®</button>
    </div>
    <p class="info">Ê®°Êì¨2.5ÂÑÑÂπ¥ÊùøÂ°äÊºÇÁßªÔºåÂæûÁõ§Âè§Â§ßÈô∏Âà∞Êú™‰æÜAmasia„ÄÇÊãñÂãïÊôÇÈñìËª∏Êé¢Á¥¢ÔºÅ</p>
  </div>

  <script>
    // Fallback for CDN (new: local polyfill if needed, but rare)
    function loadFallbackThree() { console.error('CDN failed‚Äîtry refresh'); }

    let scene, camera, renderer, earth, controls;
    let isPlaying = false;
    let direction = 1;
    const debugDiv = document.getElementById('debug');

    // Enhanced textures: More fallbacks, faster load
    const textures = {
      "-600": { url: "https://i.imgur.com/2f5mK8J.jpg", color: 0x4a4a4a },
      "-540": { url: "https://i.imgur.com/8Y3vXpL.jpg", color: 0x5a5a5a },
      "-450": { url: "https://i.imgur.com/QkR8mP0.jpg", color: 0x6a6a6a },
      "-335": { url: "https://i.imgur.com/X7pL9sN.jpg", color: 0x7a7a7a },
      "-250": { url: "https://i.imgur.com/4r9vZkE.jpg", color: 0x8a8a8a },
      "-200": { url: "https://i.imgur.com/J8sL2pX.jpg", color: 0x9a9a9a }, // Pangea
      "-150": { url: "https://i.imgur.com/oP7nR5v.jpg", color: 0xa0a0a0 },
      "-100": { url: "https://i.imgur.com/W2kX9mZ.jpg", color: 0xb0b0b0 },
      "-50":  { url: "https://i.imgur.com/9tY5vHq.jpg", color: 0xc0c0c0 },
      "0":    { url: "https://i.imgur.com/0vL8g7P.jpg", color: 0x006994 }, // Modern
      "50":   { url: "https://i.imgur.com/L5pR9kD.jpg", color: 0xd0d0d0 },
      "100":  { url: "https://i.imgur.com/H3mX2vN.jpg", color: 0xe0e0e0 },
      "250":  { url: "https://i.imgur.com/Z9kP7wQ.jpg", color: 0xf0f0f0 }  // Amasia
    };

    function init() {
      try {
        if (typeof THREE === 'undefined') { throw new Error('Three.js not loaded'); }
        debugDiv.textContent = 'Creating scene...';
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000011);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 4;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true; // New: Shadows for depth
        document.getElementById('container').appendChild(renderer.domElement);

        debugDiv.textContent = 'Loading controls...';
        if (typeof THREE.OrbitControls !== 'undefined') {
          controls = new THREE.OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true;
          controls.dampingFactor = 0.08; // Smoother damping update
          controls.enableZoom = true;
          controls.minDistance = 2; // New: Zoom limits
          controls.maxDistance = 10;
        } else {
          throw new Error('OrbitControls missing');
        }

        debugDiv.textContent = 'Building Earth globe...';
        const geometry = new THREE.SphereGeometry(1.8, 64, 64);
        const loader = new THREE.TextureLoader({ crossOrigin: 'anonymous' }); // New: CORS fix
        const texData = textures["0"];
        const initialTex = loader.load(texData.url, 
          () => { console.log('Initial texture loaded'); }, 
          undefined, 
          () => { console.warn('Texture fallback to color'); }
        );
        const material = new THREE.MeshPhongMaterial({
          map: initialTex,
          color: texData.color,
          shininess: 30, // Updated: Shinier for realism
          specular: 0x222222
        });
        earth = new THREE.Mesh(geometry, material);
        scene.add(earth);

        // Enhanced lighting: New point light for glow
        const ambient = new THREE.AmbientLight(0x404040, 0.4);
        scene.add(ambient);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
        dirLight.position.set(5, 3, 5);
        dirLight.castShadow = true; // New: Shadows
        scene.add(dirLight);
        const pointLight = new THREE.PointLight(0x00ffcc, 0.5, 10); // New: Cyan glow
        pointLight.position.set(-5, 0, 5);
        scene.add(pointLight);

        // Teaser: Simple plate boundary lines (new script feature)
        const boundaries = new THREE.Group();
        for (let i = 0; i < 10; i++) { // Placeholder lines
          const lineGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5)]);
          const lineMat = new THREE.LineBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.6 });
          boundaries.add(new THREE.Line(lineGeo, lineMat));
        }
        earth.add(boundaries);

        debugDiv.textContent = 'üåç Earth Spinning! Drag to orbit, scroll to zoom.';
        debugDiv.classList.add('success');
        console.log('GeoDrift v3 initialized! Enhanced style/script active.');

        // UI Hooks (unchanged but with debounce for mobile)
        const slider = document.getElementById('timeSlider');
        let timeout;
        slider.addEventListener('input', e => {
          clearTimeout(timeout);
          timeout = setTimeout(() => updateTime(parseInt(e.target.value)), 50); // New: Debounce
        });
        document.getElementById('playBtn').addEventListener('click', () => {
          isPlaying = !isPlaying;
          document.getElementById('playBtn').innerText = isPlaying ? 'Êö´ÂÅú' : 'Êí≠ÊîæÂãïÁï´';
        });
        document.getElementById('resetBtn').addEventListener('click', () => {
          slider.value = 0;
          updateTime(0);
          isPlaying = false;
          document.getElementById('playBtn').innerText = 'Êí≠ÊîæÂãïÁï´';
        });

        window.addEventListener('resize', onResize);
        animate();
      } catch (error) {
        debugDiv.textContent = 'Init Error: ' + error.message + ' (Refresh or check console)';
        debugDiv.style.color = 'red';
        console.error('GeoDrift init failed:', error);
      }
    }

    function updateTime(ma) {
      const keys = Object.keys(textures).map(Number).sort((a, b) => a - b);
      const closest = keys.reduce((prev, curr) => Math.abs(curr - ma) < Math.abs(prev - ma) ? curr : prev);
      const texData = textures[closest];

      new THREE.TextureLoader({ crossOrigin: 'anonymous' }).load(texData.url, tex => {
        earth.material.map = tex;
        earth.material.color.setHex(0xffffff);
        earth.material.needsUpdate = true;
        console.log(`Switched to ${closest} Ma (${ma === closest ? 'exact' : 'closest'})`);
      }, undefined, () => {
        earth.material.map = null;
        earth.material.color.setHex(texData.color);
        earth.material.needsUpdate = true;
      });

      const label = ma < 0 ? `${Math.abs(ma)} ÁôæËê¨Âπ¥Ââç` : ma > 0 ? `Êú™‰æÜ ${ma} ÁôæËê¨Âπ¥` : 'ÁèæÂú®';
      document.getElementById('timeLabel').textContent = label;
    }

    function animate() {
      requestAnimationFrame(animate);
      if (controls) controls.update();
      if (earth) {
        earth.rotation.y += 0.005;
        earth.rotation.x += 0.001; // New: Subtle tilt animation
      }

      if (isPlaying) {
        const slider = document.getElementById('timeSlider');
        let val = parseInt(slider.value) + direction * 5;
        val = Math.max(-600, Math.min(250, val));
        if (val >= 250 || val <= -600) direction *= -1;
        slider.value = val;
        updateTime(val);
      }

      if (renderer) renderer.render(scene, camera);
    }

    function onResize() {
      if (camera && renderer) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    }

    // Force init after short delay (new: bypass load issues)
    setTimeout(init, 100);
    window.addEventListener('load', init); // Double-call safe
  </script>
</body>
</html>
